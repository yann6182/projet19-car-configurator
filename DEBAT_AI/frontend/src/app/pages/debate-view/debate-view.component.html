<div class="container">
  
  <!-- 1. LA BANNIÃˆRE DE TITRE (Nouveau) -->
  <div class="topic-banner" *ngIf="debateTopic">
    <h3>{{ debateTopic }}</h3>
  </div>

  <!-- 2. LE HEADER (Scoreboard + Actions) -->
  <header class="debate-header">
    
    <!-- Bouton Retour -->
    <a routerLink="/" class="icon-btn" title="Exit without saving">âœ•</a>

    <!-- Score Board -->
    <div class="score-board">
      <div class="score-side side-a" [class.leading]="scoreA > scoreB">
        <span class="score-name">{{ playerA }}</span>
        <span class="score-num">{{ scoreA }}</span>
      </div>
      <div class="vs-badge">VS</div>
      <div class="score-side side-b" [class.leading]="scoreB > scoreA">
        <span class="score-num">{{ scoreB }}</span>
        <span class="score-name">{{ playerB }}</span>
      </div>
    </div>

    <!-- Actions Ã  droite (Switcher + Finish) -->
    <div class="header-actions" style="display: flex; gap: 10px; align-items: center;">
      
      <!-- Switcher de Joueur -->
      <div class="user-toggle">
        
        <!-- JOUEUR A (PRO) -->
        <button 
          class="toggle-btn" 
          [class.active]="username === playerA"
          (click)="switchUser(playerA)">
          <span class="role-tag pro">PRO</span>
          {{ playerA }}
        </button>

        <!-- JOUEUR B (CON) -->
        <button 
          class="toggle-btn" 
          [class.active]="username === playerB"
          (click)="switchUser(playerB)">
          <span class="role-tag con">CON</span>
          {{ playerB }}
        </button>

      </div>

      <!-- BOUTON FINISH -->
      <button class="btn-finish" (click)="finishDebate()">
        ğŸ FINISH
      </button>

    </div> 
    <!-- Fin de header-actions (C'est souvent ce div qui manquait) -->

  </header>

  <!-- 3. ZONE DES MESSAGES -->
  <div class="message-container" #messageContainer>
    <div *ngIf="messages.length === 0" class="loading">
      Start the debate! Type a message as {{ username }}...
    </div>

    <div *ngFor="let msg of messages" class="message" 
         [ngClass]="{
           'my-message': msg.username === username, 
           'other-message': msg.username !== username
         }">
      
      <!-- BULLE -->
      <div class="message-bubble" 
           [class.winner-bubble]="isWinner(msg.id)"
           [class.loser-bubble]="!isWinner(msg.id)">
        
        <!-- Header Message -->
        <div class="message-header-row">
          <div class="message-author">{{ msg.username }}</div>
          
          <span *ngIf="msg.relation_type === 'attack'" class="badge badge-attack">âš”ï¸ ATTACK</span>
          <span *ngIf="msg.relation_type === 'support'" class="badge badge-support">ğŸ›¡ï¸ SUPPORT</span>
          <span *ngIf="msg.target_id" class="target-ref">â†³ Ref #{{msg.target_id}}</span>
        </div>

        <!-- Contenu -->
        <div class="message-content">{{ msg.content }}</div>

        <!-- Feedback IA -->
        <div *ngIf="msg.feedback" class="ai-feedback">
          ğŸ¤– <em>Analyze: {{ msg.feedback }}</em>
        </div>

        <!-- Suggestions -->
        <div *ngIf="msg.username !== username" class="suggestion-area">
          <button (click)="askForHelp(msg.id)" class="btn-help" *ngIf="!suggestionsMap[msg.id]">
            {{ loadingSuggestionId === msg.id ? 'Thinking...' : 'ğŸ’¡ Suggest Counter-Argument' }}
          </button>

          <div *ngIf="suggestionsMap[msg.id]" class="suggestions-box">
            <small><strong>AI Suggestions:</strong></small>
            <ul>
              <li *ngFor="let idea of suggestionsMap[msg.id]">{{ idea }}</li>
            </ul>
          </div>
        </div>
        

      </div>
    </div>
  </div>

  <!-- 4. FOOTER (INPUT) -->
  <footer class="message-form-container">
    <form>
      <textarea 
        class="chat-input"
        [placeholder]="'Type your argument as ' + username + '...'"
        [(ngModel)]="newMessageContent"
        name="newMessageContent"
        (keydown)="onKeydown($event)"
        rows="1"
      ></textarea>
      
      <button type="button" (click)="sendMessage()" [disabled]="!newMessageContent.trim()">
        Send
      </button>
    </form>
  </footer>

  <!-- MODALE DE VICTOIRE (Overlay) -->
  <div class="winner-overlay" *ngIf="showWinnerModal">
    <div class="winner-card-popup">
      
      <div class="trophy-icon">ğŸ†</div>
      
      <h2>DEBATE FINISHED</h2>
      
      <div class="winner-announce">
        <span *ngIf="winnerName !== 'Draw'" class="the-winner">Winner: {{ winnerName }}</span>
        <span *ngIf="winnerName === 'Draw'" class="the-winner">It's a Draw!</span>
      </div>

      <div class="final-score-display">
        <span [class.win-text]="scoreA >= scoreB">{{ playerA }} ({{ scoreA }})</span>
        <span class="vs-text">vs</span>
        <span [class.win-text]="scoreB >= scoreA">{{ playerB }} ({{ scoreB }})</span>
      </div>

      <p class="winner-subtext">{{ winnerMessage }}</p>

      <div class="modal-actions">
        <button class="btn-cancel-modal" (click)="cancelFinish()">Wait, continue debate</button>
        <button class="btn-confirm-modal" (click)="confirmReset()">End & Reset Match</button>
      </div>

    </div>
  </div>

</div>